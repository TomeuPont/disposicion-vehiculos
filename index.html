<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Plano Taller Camiones</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
    }
    .panel-lateral {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    .panel-lateral button {
      margin-right: 8px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .plano-container {
      position: relative;
      width: 100%;
      height: 100%;
      background-image: url('plano-fondo.png');
      background-size: cover;
      background-position: center;
      border: 2px solid #333;
    }
    .bloque {
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: #ccc;
      border: 1px solid #000;
      border-radius: 6px;
      font-size: 10px;
      text-align: center;
      padding: 2px;
      cursor: grab;
      user-select: none;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-sizing: border-box;
      line-height: 1.2;
    }
    .bloque .numero {
      font-weight: bold;
      font-size: 16px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
    }
    .modal-content input {
      width: 100%;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .close {
      float: right;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="panel-lateral">
  <button onclick="alternarUbicacion()" id="btnUbicacion">Campa</button>
  <button onclick="alternarModo()" id="botonModo">Cambiar a modo edición</button>
</div>
<div class="plano-container" id="plano"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>Editar Bloque</h3>
    <input type="text" id="actividad" placeholder="Nº Actividad">
    <input type="text" id="matricula" placeholder="Matrícula">
    <input type="text" id="marca" placeholder="Marca">
    <input type="text" id="cliente" placeholder="Cliente">
    <input type="text" id="trabajador" placeholder="Trabajador">
    <button onclick="guardarDatos()">Guardar</button>
    <button onclick="liberarDatos()">Liberar</button>
  </div>
</div>

<div id="mensajeEstado" style="position:fixed; bottom:10px; right:10px; background:#eee; padding:8px 12px; border-radius:6px; box-shadow: 0 0 4px rgba(0,0,0,0.3); font-size:14px; display:none;">Estado</div>
<div style="position:fixed; top:10px; right:10px; background:#222; color:#fff; padding:4px 10px; border-radius:4px; font-size:12px; font-family:monospace; z-index:20;">Versión 1.1.4</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js">window.addEventListener('resize', () => {
  bloques.forEach((bloque) => {
    const i = parseInt(bloque.dataset.index);
    const info = datos[i];
    if (info.topPct !== undefined && info.leftPct !== undefined) {
      bloque.style.top = info.topPct.toFixed(2) + '%';
      bloque.style.left = info.leftPct.toFixed(2) + '%';
    }
  });
});
</script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "813627250056",
  authDomain: "planos-taller-campa.firebaseapp.com",
  projectId: "planos-taller-campa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let bloques = [];
let datos = {};
let modoEdicion = false;
let bloqueActual;
let ubicacionActual = 'taller';

const plano = document.getElementById('plano');
const modal = document.getElementById('modal');
const actividadInput = document.getElementById('actividad');
const clienteInput = document.getElementById('cliente');
const trabajadorInput = document.getElementById('trabajador');
const matriculaInput = document.getElementById('matricula');
const marcaInput = document.getElementById('marca');
const botonModo = document.getElementById('botonModo');
const botonUbicacion = document.getElementById('btnUbicacion');
const closeModal = document.getElementById('closeModal');

const posicionesTaller = [...Array(30)].map((_, i) => ({top: 300 + (i % 5) * 60, left: 400 + Math.floor(i / 5) * 60}));
const posicionesCampa = [...Array(30)].map((_, i) => ({top: 100 + (i % 5) * 60, left: 100 + Math.floor(i / 5) * 60}));

function alternarUbicacion() {
  ubicacionActual = ubicacionActual === 'taller' ? 'campa' : 'taller';
  botonUbicacion.textContent = ubicacionActual === 'taller' ? 'Campa' : 'Taller';
  cargarDesdeFirestore();
}

function alternarModo() {
  modoEdicion = !modoEdicion;
  botonModo.textContent = modoEdicion ? 'Bloquear edición' : 'Cambiar a modo edición';
}

function actualizarFondo() {
  plano.style.backgroundImage = `url('${ubicacionActual === 'taller' ? 'plano-fondo.png' : 'plano-campa.png'}')`;
}

function crearBloques() {
  plano.innerHTML = '';
  bloques = [];
  const posiciones = ubicacionActual === 'taller' ? posicionesTaller : posicionesCampa;
  for (let i = 0; i < 30; i++) {
    const div = document.createElement('div');
    div.className = 'bloque';
    const globalIndex = ubicacionActual === 'taller' ? i : i + 30;
    div.dataset.index = globalIndex;
    const pos = posiciones[i];
    if (datos[globalIndex] && datos[globalIndex].topPct !== undefined && datos[globalIndex].leftPct !== undefined) {
      div.style.top = datos[globalIndex].topPct.toFixed(2) + '%';
      div.style.left = datos[globalIndex].leftPct.toFixed(2) + '%';
    } else {
      const topPct = (pos.top / plano.offsetHeight) * 100;
      const leftPct = (pos.left / plano.offsetWidth) * 100;
      datos[globalIndex].topPct = topPct;
      datos[globalIndex].leftPct = leftPct;
      db.collection('bloques').doc(globalIndex.toString()).set(datos[globalIndex], { merge: true });
      div.style.top = topPct.toFixed(2) + '%';
      div.style.left = leftPct.toFixed(2) + '%';
      div.style.top = pos.top + 'px';
      div.style.left = pos.left + 'px';
    }
    plano.appendChild(div);
    bloques.push(div);
    if (!datos[globalIndex]) datos[globalIndex] = {actividad: '', cliente: '', trabajador: '', matricula: '', marca: '', ocupado: false};

    div.addEventListener('click', () => {
      if (!modoEdicion) abrirModal(div);
    });

    let isDragging = false;
    let offsetX, offsetY;

    div.addEventListener('mousedown', (e) => {
      if (!modoEdicion) return;
      isDragging = true;
      offsetX = e.offsetX;
      offsetY = e.offsetY;
      div.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging || !modoEdicion) return;
      const rect = plano.getBoundingClientRect();
      const x = e.clientX - rect.left - offsetX;
      const y = e.clientY - rect.top - offsetY;
      if (x >= 0 && y >= 0 && x <= plano.offsetWidth - 50 && y <= plano.offsetHeight - 50) {
        div.style.left = `${x}px`;
        div.style.top = `${y}px`;
      }
    });

    document.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        div.style.cursor = 'grab';
        const index = div.dataset.index;
        if (!datos[index]) datos[index] = {};
        const topPercent = (parseInt(div.style.top) / plano.offsetHeight) * 100;
        const leftPercent = (parseInt(div.style.left) / plano.offsetWidth) * 100;
        datos[index].top = parseInt(div.style.top);
        datos[index].left = parseInt(div.style.left);
        datos[index].topPct = topPercent;
        datos[index].leftPct = leftPercent;
        db.collection('bloques').doc(index).set(datos[index], { merge: true });
      }
    });
  }
  renderizarBloques();
  actualizarFondo();
}

function abrirModal(bloque) {
  bloqueActual = bloque;
  const index = bloque.dataset.index;
  const info = datos[index];
  actividadInput.value = info.actividad;
  clienteInput.value = info.cliente;
  trabajadorInput.value = info.trabajador;
  matriculaInput.value = info.matricula;
  marcaInput.value = info.marca;
  modal.style.display = 'flex';
}

function guardarDatos() {
  const index = bloqueActual.dataset.index;
  datos[index] = {
    actividad: actividadInput.value,
    cliente: clienteInput.value,
    trabajador: trabajadorInput.value,
    matricula: matriculaInput.value.toUpperCase(),
    marca: marcaInput.value.toUpperCase(),
    ocupado: true
  };
  db.collection('bloques').doc(index).set(datos[index]);
  renderizarBloques();
  modal.style.display = 'none';
}

function liberarDatos() {
  const index = bloqueActual.dataset.index;
  datos[index] = {actividad: '', cliente: '', trabajador: '', matricula: '', marca: '', ocupado: false};
  db.collection('bloques').doc(index).set(datos[index]);
  renderizarBloques();
  modal.style.display = 'none';
}

function renderizarBloques() {
  bloques.forEach((bloque) => {
    const i = parseInt(bloque.dataset.index);
    const info = datos[i];
    if (info.ocupado) {
      bloque.style.backgroundColor = info.trabajador ? '#f00' : '#8f8';
      bloque.innerHTML = `<div class='numero'>${i + 1}</div><div style='font-size:8px;'>Act: ${info.actividad}<br>${info.cliente}</div>`;
    } else {
      bloque.style.backgroundColor = '#ccc';
      bloque.innerHTML = `<div class='numero'>${i + 1}</div>`;
    }
  });
}

function cargarDesdeFirestore() {
  db.collection("bloques").get().then((querySnapshot) => {
    querySnapshot.forEach((doc) => {
      datos[doc.id] = doc.data();
    });
    crearBloques();
  });
}

closeModal.onclick = () => modal.style.display = 'none';
cargarDesdeFirestore();
</script>
</body>
</html>
